<section class="api-docs" id="api-docs">
  <header class="api-hero">
    <div class="api-hero-top">
      <!-- Add under .api-hero-top -->
      <div class="api-cred" data-api-cred hidden>
        <div class="api-cred-left">
          <div class="api-cred-title">API Credentials</div>
          <div class="api-cred-sub">
            <span data-api-user-name>—</span>
            <span class="api-dot">•</span>
            <span data-api-user-email>—</span>
            <span class="api-dot">•</span>
            <span data-api-user-plan>—</span>
          </div>
        </div>

        <div class="api-cred-right">
          <div class="api-cred-row">
            <span class="api-cred-k">API Key</span>
            <code class="api-cred-v" data-api-key>••••••••••••••••</code>
            <button class="api-copy" type="button" data-copy-btn="" data-api-copy-key aria-label="Copy API key">
              Copy
            </button>
            <button class="api-btn api-btn-ghost" type="button" data-api-rotate-key>
              Rotate
            </button>
          </div>
          <div class="api-cred-meta api-muted">
            <span>Created:</span> <span data-api-key-created>—</span>
            <span class="api-dot">•</span>
            <span>Last used:</span> <span data-api-key-last-used>—</span>
          </div>
        </div>
      </div>      
      <div class="api-hero-title">
        <div class="api-pill">Docs / Lineage</div>
        <h2>Haiphen Trading Metrics API</h2>
        <p class="api-subtitle">
          Daily high-frequency execution telemetry, delivered as <strong>REST</strong> and <strong>RSS</strong>.
          Built for transparency, auditability, and automation.
        </p>
      </div>

      <div class="api-hero-actions">
        <a class="api-btn api-btn-primary" href="javascript:void(0)" data-api-action="request-access">Request access</a>
        <a class="api-btn api-btn-ghost" href="javascript:void(0)" data-api-action="view-changelog">Changelog</a>
      </div>
    </div>

    <div class="api-hero-cards" role="region" aria-label="API quick facts">
      <div class="api-card">
        <div class="api-card-k">Base URL</div>
        <div class="api-card-v">
          <code data-copy="https://api.haiphen.io/v1">https://api.haiphen.io/v1</code>
          <button class="api-copy" type="button" data-copy-btn="https://api.haiphen.io/v1" aria-label="Copy base URL">
            Copy
          </button>
        </div>
        <div class="api-card-s">All endpoints below are relative to this base.</div>
      </div>

      <div class="api-card">
        <div class="api-card-k">Auth</div>
        <div class="api-card-v"><code>Authorization: Bearer &lt;API_KEY&gt;</code></div>
        <div class="api-card-s">Per-user keys. Rotate anytime. Least-privilege scopes.</div>
      </div>

      <div class="api-card">
        <div class="api-card-k">Admin ingest</div>
        <div class="api-card-v"><code>X-Admin-Token: &lt;ADMIN_TOKEN&gt;</code></div>
        <div class="api-card-s">Privileged upsert for daily metrics hydration.</div>
      </div>
    </div>
  </header>

  <div class="api-layout">
    <!-- Sidebar -->
    <aside class="api-sidebar" aria-label="Documentation navigation">
      <div class="api-sidebar-head">
        <div class="api-sidebar-title">Contents</div>
        <input
          class="api-filter"
          type="search"
          placeholder="Filter sections…"
          aria-label="Filter documentation sections"
          data-api-filter
        />
      </div>

      <nav class="api-nav" data-api-nav><!-- injected --></nav>

      <div class="api-sidebar-foot">
        <div class="api-muted">Tip: Share a deep link via <code>#docs:section-id</code>.</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="api-main" data-api-main>
      <!-- Tabs -->
      <div class="api-tabs" role="tablist" aria-label="API documentation modes">
        <button class="api-tab is-active" type="button" role="tab" aria-selected="true" data-api-tab="rest">REST</button>
        <button class="api-tab" type="button" role="tab" aria-selected="false" data-api-tab="rss">RSS</button>
        <button class="api-tab" type="button" role="tab" aria-selected="false" data-api-tab="webhooks">Webhooks</button>
      </div>

      <!-- REST -->
      <section class="api-panel is-active" data-api-panel="rest">
        <!-- Overview -->
        <section class="api-section" id="docs-overview" data-api-section>
          <h3>Overview</h3>
          <p>
            The Haiphen Metrics API exposes daily snapshots of intraday execution telemetry from a high-frequency
            options engine. The contract is designed to be boring: stable shapes, consistent errors, and clear provenance.
          </p>

          <div class="api-callout">
            <div class="api-callout-title">Non-advisory disclaimer</div>
            <p class="api-muted">
              This API provides telemetry, not trade instructions. Treat outputs as informational signals and diagnostics
              — not financial advice.
            </p>
          </div>

          <div class="api-grid2">
            <div class="api-mini">
              <div class="api-mini-k">Primary resources</div>
              <div class="api-mini-v">KPIs • Series • Portfolio Assets</div>
              <div class="api-mini-s">KPIs are the “index”. Series + assets are the drill-down.</div>
            </div>
            <div class="api-mini">
              <div class="api-mini-k">Correlation</div>
              <div class="api-mini-v"><code>X-Request-Id</code></div>
              <div class="api-mini-s">Every response returns a request id for debugging across infra.</div>
            </div>
          </div>
        </section>

        <!-- Quickstart -->
        <section class="api-section" id="docs-quickstart" data-api-section>
          <h3>Quickstart (CLI)</h3>
          <p>Set your environment variables:</p>

          <pre class="api-code"><code data-lang="bash">export API_BASE="https://api.haiphen.io"
export API_KEY="..."        # per-user bearer token
export ADMIN_TOKEN="..."    # admin-only token</code></pre>

          <p>Optional helpers (mirrors your shell):</p>

          <pre class="api-code"><code data-lang="bash">api_path() {
  local path="$1"
  [[ "$path" == /* ]] || path="/$path"
  if [[ "$path" != /v1/* ]]; then
    path="/v1$path"
  fi
  printf "%s" "$path"
}

api_post() {
  local path; path="$(api_path "$1")"; shift
  curl -sS -X POST "$API_BASE$path" "$@"
}

api_get() {
  local path; path="$(api_path "$1")"; shift
  curl -sS -X GET "$API_BASE$path" "$@"
}</code></pre>

          <p>Hydrate latest metrics (admin):</p>
          <pre class="api-code"><code data-lang="bash">api_post "/admin/metrics/upsert" \
  -H "Content-Type: application/json" \
  -H "X-Admin-Token: $ADMIN_TOKEN" \
  --data '{"url":"https://haiphen.io/assets/trades/trades.json"}' | jq .</code></pre>

          <p>Fetch KPI index (user):</p>
          <pre class="api-code"><code data-lang="bash">api_get "/metrics/kpis" \
  -H "Authorization: Bearer $API_KEY" | jq .</code></pre>
        </section>

        <!-- Try it -->
        <section class="api-section" id="docs-try" data-api-section>
          <h3>Try it (in-browser)</h3>
          <p class="api-muted">
            This runs requests from your browser. Your API key is stored in <code>sessionStorage</code> (clears when the tab closes).
          </p>

          <div class="api-try">
            <div class="api-try-row">
              <label class="api-try-label">
                Base URL
                <input class="api-try-input" type="text" data-api-try-base placeholder="https://api.haiphen.io" />
              </label>
              <label class="api-try-label">
                API Key (Bearer)
                <input class="api-try-input" type="password" data-api-try-key placeholder="…" />
              </label>
            </div>

            <div class="api-try-actions">
              <button class="api-btn api-btn-primary" type="button" data-api-try-save>Save</button>
              <button class="api-btn api-btn-ghost" type="button" data-api-try-clear>Clear</button>
            </div>

            <div class="api-try-actions">
              <button class="api-btn" type="button" data-api-try="kpis">GET /v1/metrics/kpis</button>
              <button class="api-btn" type="button" data-api-try="assets">GET /v1/metrics/portfolio-assets?limit=5</button>
              <button class="api-btn" type="button" data-api-try="series">GET /v1/metrics/series?kpi=Daily%20PnL&amp;limit=5</button>
            </div>

            <pre class="api-code api-try-out"><code data-api-try-out data-lang="json">{
  "hint": "Click a request above. Output will render here."
}</code></pre>
          </div>
        </section>

        <!-- Auth -->
        <section class="api-section" id="docs-auth" data-api-section>
          <h3>Authentication</h3>

          <h4>User key (Bearer)</h4>
          <pre class="api-code"><code data-lang="bash">curl -sS "https://api.haiphen.io/v1/metrics/kpis" \
  -H "Authorization: Bearer $API_KEY"</code></pre>

          <h4>Admin token (hydration)</h4>
          <pre class="api-code"><code data-lang="bash">curl -sS -X POST "https://api.haiphen.io/v1/admin/metrics/upsert" \
  -H "Content-Type: application/json" \
  -H "X-Admin-Token: $ADMIN_TOKEN" \
  --data '{"url":"https://haiphen.io/assets/trades/trades.json"}'</code></pre>

          <div class="api-callout">
            <div class="api-callout-title">Key hygiene</div>
            <ul class="api-ul">
              <li>Never ship admin tokens to browsers.</li>
              <li>Rotate user keys without downtime: issue new → deploy → revoke old.</li>
              <li>Prefer plan-tier scopes server-side (even if hidden behind a single key today).</li>
            </ul>
          </div>
        </section>

        <!-- Rate limits -->
        <section class="api-section" id="docs-rate-limits" data-api-section>
          <h3>Rate limits</h3>
          <p>
            Limits should be explicit and plan-based. Suggested defaults (tunable):
          </p>

          <div class="api-table" role="table" aria-label="Rate limits">
            <div class="api-row api-head" role="row">
              <div role="columnheader">Plan</div>
              <div role="columnheader">Requests</div>
              <div role="columnheader">Window</div>
              <div role="columnheader">Burst</div>
            </div>
            <div class="api-row" role="row">
              <div role="cell"><strong>Free</strong></div>
              <div role="cell">60</div>
              <div role="cell">minute</div>
              <div role="cell">10</div>
            </div>
            <div class="api-row" role="row">
              <div role="cell"><strong>Pro</strong></div>
              <div role="cell">600</div>
              <div role="cell">minute</div>
              <div role="cell">60</div>
            </div>
            <div class="api-row" role="row">
              <div role="cell"><strong>Enterprise</strong></div>
              <div role="cell">Custom</div>
              <div role="cell">—</div>
              <div role="cell">—</div>
            </div>
          </div>

          <p class="api-muted">
            Return <code>429</code> with <code>Retry-After</code>. Include:
            <code>X-RateLimit-Limit</code>, <code>X-RateLimit-Remaining</code>, <code>X-RateLimit-Reset</code>.
          </p>
        </section>

        <!-- Data model -->
        <section class="api-section" id="docs-data-model" data-api-section>
          <h3>Data model</h3>

          <h4>KPI items</h4>
          <p class="api-muted">
            <code>/metrics/kpis</code> returns the daily KPI index. Values are either numeric or pre-formatted text.
          </p>

          <pre class="api-code"><code data-lang="json">{
  "date": "2026-01-06",
  "items": [
    { "kpi": "Avg hold time", "value_text": "13s", "value_num": null, "value_kind": "text" },
    { "kpi": "Decay Rate", "value_text": "8.835613", "value_num": 8.835613, "value_kind": "number" }
  ]
}</code></pre>

          <h4>Series points</h4>
          <p class="api-muted">
            <code>/metrics/series</code> returns time-series points for a specific KPI.
            <strong>Important:</strong> today the <code>kpi</code> parameter should match the KPI label used in <code>/metrics/kpis</code>
            (example: <code>Daily PnL</code>), not necessarily a slug like <code>total_pnl</code>.
          </p>

          <pre class="api-code"><code data-lang="json">{
  "date": "2026-01-06",
  "kpi": "Daily PnL",
  "points": [
    { "t": "2026-01-06T14:31:00.000Z", "v": 123.45 },
    { "t": "2026-01-06T14:32:00.000Z", "v": 128.10 }
  ],
  "next_cursor": null
}</code></pre>

          <div class="api-callout">
            <div class="api-callout-title">Recommended alias behavior (server-side)</div>
            <p class="api-muted">
              To support both humans and machines, consider accepting either:
              <code>kpi=Daily%20PnL</code> (label) OR <code>kpi_id=total_pnl</code> (slug).
              The docs below assume current behavior is label-based.
            </p>
          </div>
        </section>

        <!-- Endpoints -->
        <section class="api-section" id="docs-endpoints" data-api-section>
          <h3>Endpoints</h3>

          <div class="api-endpoints">
            <!-- KPIs -->
            <div class="api-endpoint">
              <div class="api-endpoint-top">
                <span class="api-method">GET</span>
                <code class="api-path" data-copy="/metrics/kpis">/metrics/kpis</code>
                <button class="api-copy" type="button" data-copy-btn="/metrics/kpis">Copy</button>
              </div>
              <div class="api-endpoint-desc">Fetch the daily KPI index (defaults to latest date).</div>
              <div class="api-endpoint-meta">
                <div><strong>Auth:</strong> Bearer API key</div>
                <div><strong>Query (optional):</strong> <code>date=YYYY-MM-DD</code></div>
                <div><strong>Returns:</strong> <code>{ date, items[] }</code></div>
              </div>

              <pre class="api-code"><code data-lang="bash">curl -sS "https://api.haiphen.io/v1/metrics/kpis" \
  -H "Authorization: Bearer $API_KEY" | jq .</code></pre>
            </div>

            <!-- Series -->
            <div class="api-endpoint">
              <div class="api-endpoint-top">
                <span class="api-method">GET</span>
                <code class="api-path" data-copy="/metrics/series">/metrics/series</code>
                <button class="api-copy" type="button" data-copy-btn="/metrics/series">Copy</button>
              </div>
              <div class="api-endpoint-desc">Fetch time-series points for a KPI on a given date.</div>
              <div class="api-endpoint-meta">
                <div><strong>Auth:</strong> Bearer API key</div>
                <div><strong>Query:</strong> <code>kpi=&lt;KPI label&gt;</code> (e.g. <code>Daily%20PnL</code>)</div>
                <div><strong>Optional:</strong> <code>date</code>, <code>limit</code>, <code>cursor</code></div>
                <div><strong>Returns:</strong> <code>{ date, kpi, points[], next_cursor }</code></div>
              </div>

              <pre class="api-code"><code data-lang="bash">curl -sS "https://api.haiphen.io/v1/metrics/series?kpi=Daily%20PnL&amp;limit=25" \
  -H "Authorization: Bearer $API_KEY" | jq .</code></pre>

              <div class="api-callout">
                <div class="api-callout-title">Troubleshooting: empty points</div>
                <ul class="api-ul">
                  <li>Confirm the KPI label exists via <code>GET /metrics/kpis</code>.</li>
                  <li>Use the returned <code>kpi</code> string exactly (case + spacing).</li>
                  <li>If you want slug support (<code>total_pnl</code>), add a server-side alias map.</li>
                </ul>
              </div>
            </div>

            <!-- Portfolio assets -->
            <div class="api-endpoint">
              <div class="api-endpoint-top">
                <span class="api-method">GET</span>
                <code class="api-path" data-copy="/metrics/portfolio-assets">/metrics/portfolio-assets</code>
                <button class="api-copy" type="button" data-copy-btn="/metrics/portfolio-assets">Copy</button>
              </div>
              <div class="api-endpoint-desc">Fetch portfolio asset rows (top holdings / components) for the latest day.</div>
              <div class="api-endpoint-meta">
                <div><strong>Auth:</strong> Bearer API key</div>
                <div><strong>Query (optional):</strong> <code>date</code>, <code>limit</code>, <code>cursor</code></div>
                <div><strong>Returns:</strong> <code>{ date, items[], next_cursor }</code></div>
              </div>

              <pre class="api-code"><code data-lang="bash">curl -sS "https://api.haiphen.io/v1/metrics/portfolio-assets?limit=5" \
  -H "Authorization: Bearer $API_KEY" | jq .</code></pre>
            </div>

            <!-- Admin upsert -->
            <div class="api-endpoint">
              <div class="api-endpoint-top">
                <span class="api-method">POST</span>
                <code class="api-path" data-copy="/admin/metrics/upsert">/admin/metrics/upsert</code>
                <button class="api-copy" type="button" data-copy-btn="/admin/metrics/upsert">Copy</button>
              </div>
              <div class="api-endpoint-desc">Admin hydration: ingest/update metrics for a day from a JSON URL.</div>
              <div class="api-endpoint-meta">
                <div><strong>Auth:</strong> <code>X-Admin-Token</code></div>
                <div><strong>Body:</strong> <code>{"url":"https://haiphen.io/assets/trades/trades.json"}</code></div>
                <div><strong>Returns:</strong> <code>{ ok, date, updated_at }</code></div>
              </div>

              <pre class="api-code"><code data-lang="bash">curl -sS -X POST "https://api.haiphen.io/v1/admin/metrics/upsert" \
  -H "Content-Type: application/json" \
  -H "X-Admin-Token: $ADMIN_TOKEN" \
  --data '{"url":"https://haiphen.io/assets/trades/trades.json"}' | jq .</code></pre>
            </div>

            <!-- Health (recommended even if already present) -->
            <div class="api-endpoint">
              <div class="api-endpoint-top">
                <span class="api-method">GET</span>
                <code class="api-path" data-copy="/health">/health</code>
                <button class="api-copy" type="button" data-copy-btn="/health">Copy</button>
              </div>
              <div class="api-endpoint-desc">Service health (useful for monitors).</div>

              <pre class="api-code"><code data-lang="bash">curl -sS "https://api.haiphen.io/v1/health" | jq .</code></pre>
            </div>
          </div>
        </section>

        <!-- Errors -->
        <section class="api-section" id="docs-errors" data-api-section>
          <h3>Errors</h3>
          <p>Errors are consistent JSON envelopes. Always include a request id for support.</p>

          <pre class="api-code"><code data-lang="json">{
  "error": {
    "code": "unauthorized",
    "message": "Missing or invalid API key",
    "request_id": "dd44f655-af31-4a17-ae2c-e6708e5e8287"
  }
}</code></pre>

          <div class="api-grid2">
            <div class="api-mini">
              <div class="api-mini-k">Common codes</div>
              <div class="api-mini-v">
                <code>unauthorized</code>, <code>forbidden</code>, <code>not_found</code>, <code>rate_limited</code>, <code>invalid_request</code>
              </div>
            </div>
            <div class="api-mini">
              <div class="api-mini-k">Debugging</div>
              <div class="api-mini-v">Use <code>X-Request-Id</code></div>
              <div class="api-mini-s">Correlates logs, KV/D1, and worker traces.</div>
            </div>
          </div>
        </section>

        <!-- Lineage -->
        <section class="api-section" id="docs-lineage" data-api-section>
          <h3>Lineage</h3>
          <p>
            This documents the chain-of-custody from raw signals → execution → daily metrics. Keep it structured so you can
            expand without breaking clients.
          </p>

          <div class="api-callout">
            <div class="api-callout-title">Suggested lineage</div>
            <ol class="api-ol">
              <li><strong>Ingest</strong>: market data + signals</li>
              <li><strong>Score</strong>: opportunity detection + risk filters</li>
              <li><strong>Execute</strong>: orders + guardrails</li>
              <li><strong>Monitor</strong>: telemetry + exits</li>
              <li><strong>Report</strong>: KPIs + series + assets + RSS</li>
            </ol>
          </div>

          <p class="api-muted">
            Over time, include identifiers like <code>trace_id</code>, <code>pair_id</code>, <code>client_order_id</code>
            so power users can correlate across systems.
          </p>
        </section>

        <!-- Changelog -->
        <section class="api-section" id="docs-changelog" data-api-section>
          <h3>Changelog</h3>
          <div class="api-changelog">
            <div class="api-changelog-item">
              <div class="api-changelog-ver"><code>v1</code></div>
              <div class="api-changelog-body">
                <div class="api-changelog-title">Hydrated metrics + KPI index</div>
                <div class="api-muted">
                  Admin upsert (<code>/admin/metrics/upsert</code>) + user reads (<code>/metrics/kpis</code>,
                  <code>/metrics/series</code>, <code>/metrics/portfolio-assets</code>).
                </div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- RSS -->
      <section class="api-panel" data-api-panel="rss">
        <section class="api-section" id="docs-rss-overview" data-api-section>
          <h3>RSS / Atom</h3>
          <p>
            RSS is the “set it and forget it” delivery path. Ideal for dashboards, Slack bots, readers, or simple automations.
          </p>

          <div class="api-callout">
            <div class="api-callout-title">Feed URLs</div>
            <p class="api-muted">
              RSS can be public or authenticated depending on plan. Recommended approach: authenticated feeds using tokenized URLs.
            </p>
            <pre class="api-code"><code data-lang="text">https://api.haiphen.io/v1/rss/metrics?token=RSS_TOKEN</code></pre>
          </div>

          <h4>Entry shape</h4>
          <pre class="api-code"><code data-lang="xml">&lt;item&gt;
  &lt;title&gt;2026-01-06 — Daily telemetry published&lt;/title&gt;
  &lt;link&gt;https://haiphen.io/#fintech&lt;/link&gt;
  &lt;guid&gt;haiphen:metrics:2026-01-06&lt;/guid&gt;
  &lt;pubDate&gt;Tue, 06 Jan 2026 20:42:22 GMT&lt;/pubDate&gt;
  &lt;description&gt;Daily PnL • Win rate • Entries opened&lt;/description&gt;
&lt;/item&gt;</code></pre>

          <div class="api-callout">
            <div class="api-callout-title">Note</div>
            <p class="api-muted">
              If RSS is not live yet, keep this as the contract target so clients can integrate early.
            </p>
          </div>
        </section>
      </section>

      <!-- Webhooks -->
      <section class="api-panel" data-api-panel="webhooks">
        <section class="api-section" id="docs-webhooks" data-api-section>
          <h3>Webhooks</h3>
          <p>
            Webhooks are the real-time-ish path for downstream automation when new daily metrics publish.
          </p>

          <div class="api-callout">
            <div class="api-callout-title">Status</div>
            <p class="api-muted">
              If webhooks are not enabled yet, treat this as the forward contract: you can implement without breaking v1 clients.
            </p>
          </div>

          <h4>Event types</h4>
          <ul class="api-ul">
            <li><code>metrics.published</code> — daily snapshot available</li>
            <li><code>key.rotated</code> — key lifecycle events (optional)</li>
          </ul>

          <h4>Signature verification</h4>
          <p class="api-muted">Sign payloads with HMAC-SHA256 and include a timestamp header to prevent replay.</p>

          <pre class="api-code"><code data-lang="text">X-Haiphen-Timestamp: 1704463440
X-Haiphen-Signature: v1=ab12cd34…</code></pre>

          <div class="api-callout">
            <div class="api-callout-title">Recommended retry strategy</div>
            <p class="api-muted">Exponential backoff, max 24h, idempotency via <code>event_id</code>.</p>
          </div>
        </section>
      </section>
    </main>
  </div>
</section>