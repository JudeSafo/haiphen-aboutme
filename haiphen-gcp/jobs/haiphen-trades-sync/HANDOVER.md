# Trades Sync — Handover for Remote Agent

This document describes the GKE → D1 trades pipeline so that a remote AI agent (or engineer) on the GKE cluster can configure and operate the sync job.

## 1. Authentication: Token + HMAC Signature

The API endpoint requires **dual auth**:

1. **X-Internal-Token** header — must match the `INTERNAL_TOKEN` wrangler secret on haiphen-api
2. **X-Signature** header — HMAC-SHA256 of the raw JSON request body, signed with `SIGNING_SECRET`

### Signing the request

```javascript
const crypto = require("crypto");

const body = JSON.stringify(payload);
const signature = crypto.createHmac("sha256", SIGNING_SECRET).update(body).digest("hex");

fetch(url, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "X-Internal-Token": INTERNAL_TOKEN,
    "X-Signature": signature,
  },
  body,
});
```

The API verifies: `HMAC-SHA256(SIGNING_SECRET, rawBody) === X-Signature` using timing-safe comparison.

## 2. D1 Target Schema

The sync job writes to these D1 tables (all created in migrations 0001/0004):

| Table | Primary Key | Purpose |
|---|---|---|
| `metrics_daily` | `date` (TEXT, YYYY-MM-DD) | Archive row with `rows_json` + `overlay_json` blobs |
| `metrics_kpi_values` | `(date, kpi)` | Normalized KPIs per date |
| `metrics_series_points` | auto | Time-series points (date, kpi, t, v, src) |
| `metrics_extremes_items` | auto | Hi/lo extremes per KPI (18+ numeric fields) |
| `metrics_portfolio_assets` | auto | Portfolio holdings (date, trade_id, symbol, contract_name) |

The API endpoint handles all normalization and D1 upsert logic — the sync job just needs to POST the payload.

## 3. Materialized Views to Query

These PostgreSQL materialized views on the GKE cluster provide the source data:

| ConfigMap Key | MV Table | Columns Used |
|---|---|---|
| `MV_KPI_TABLE` | `utils_statistics.daily_trade_kpis_mv` | `kpi_name, display_value, sort_order, report_date` |
| `MV_SERIES_TABLE` | `utils_statistics.daily_trade_series_mv` | `kpi_name, ts, value, source, report_date` |
| `MV_EXTREMES_TABLE` | `utils_statistics.daily_trade_extremes_mv` | `kpi_name, side, rank, trade_id, symbol, contract_name, metric_raw, metric_abs, individual_pnl, abs_individual_pnl, percent_change, cost_basis, qty, bid_price, ask_price, mid_price, mid_ts, mid_mark_pnl, liquidity_drag, report_date` |
| `MV_PORTFOLIO_TABLE` | `utils_statistics.daily_trade_portfolio_mv` | `trade_id, symbol, contract_name, report_date` |

All views are filtered by `WHERE report_date = $1` using today's date (YYYY-MM-DD).

## 4. API Contract

### `POST /v1/internal/trades/snapshot`

**Auth:** `X-Internal-Token` + `X-Signature` headers (see Section 1)

**Request body (JSON):**

```json
{
  "date": "2026-02-11",
  "updated_at": "2026-02-11T14:00:00.000Z",
  "headline": "Haiphen metrics for 2026-02-11",
  "summary": "",
  "rows": [
    { "kpi": "Daily PnL", "value": "$1,234.56" },
    { "kpi": "Win rate", "value": "72.3%" }
  ],
  "overlay": {
    "seriesByKpi": {
      "Daily PnL": [
        { "t": "2026-02-11T09:30:00Z", "v": 500.25 },
        { "t": "2026-02-11T10:00:00Z", "v": 780.50, "src": "live" }
      ]
    },
    "extremes": {
      "byKpi": {
        "Daily PnL": {
          "hi": [{ "trade_id": 101, "symbol": "AAPL", "contract_name": "AAPL 250321C185", "metric_raw": 450.0 }],
          "lo": [{ "trade_id": 102, "symbol": "TSLA", "contract_name": "TSLA 250321P175", "metric_raw": -120.0 }]
        }
      }
    },
    "portfolioAssets": [
      { "trade_id": 101, "symbol": "AAPL", "contract_name": "AAPL 250321C185" }
    ]
  },
  "source": "gke-trades-sync"
}
```

**Success response (200):**

```json
{
  "ok": true,
  "date": "2026-02-11",
  "updated_at": "2026-02-11T14:00:00.000Z",
  "request_id": "abc123"
}
```

**The normalizer is flexible — it accepts these field name variants:**

- `rows` or `kpis` array
- Each row: `kpi`/`name`/`label` for name, `value`/`val`/`text` for value
- `overlay.seriesByKpi` or `overlay.series`
- Series points: `t`/`time`/`ts` for time, `v`/`value` for value
- `overlay.portfolioAssets` or `overlay.assets`

## 5. CRITICAL: Missing Metrics in MVs

The MVs currently produce a **subset** of the metrics the downstream frontend expects. A reference `trades.json` (generated by the local cron script from the same Postgres data) contains all 26 KPIs, 26 series, and 18 extremes KPIs. The MVs must be updated to match.

### 5A. KPIs returning "—" (11 missing from `daily_trade_kpis_mv`)

These KPIs exist in the reference but the MV produces no value for them:

| KPI Name | Category | Reference Value (example) |
|---|---|---|
| Opportunities flagged | Trade lifecycle | 10,333 |
| Entries opened | Trade lifecycle | 4,896 |
| Exits closed | Trade lifecycle | 1,101 |
| Avg hold time | Trade lifecycle | 2414s |
| IV Skew | Derived options | -0.0628 |
| Decay Rate | Derived options | 4.722568 |
| Gamma Exposure | Derived options | 0.009590 |
| Volume Ratio | Derived options | 17.6894 |
| OI Ratio | Derived options | 28.4023 |
| Liquidity Ratios | Derived options | 23.0458 |
| Decay Weight | Derived options | 1.4096 |

**Action**: Add these computed columns to `daily_trade_kpis_mv`. Trade lifecycle metrics come from trade state transitions; derived options metrics come from Greeks + market data aggregation.

### 5B. Missing series (11 KPIs absent from `daily_trade_series_mv`)

The MV produces 15 series KPIs. The reference has 26. Missing:

| Missing Series KPI | Reference Point Count |
|---|---|
| Avg hold time | 96 |
| Entries opened | 96 |
| Exits closed | 96 |
| Opportunities flagged | 96 |
| IV Skew | 38 |
| Decay Rate | 38 |
| Decay Weight | 38 |
| Gamma Exposure | 38 |
| Volume Ratio | 38 |
| OI Ratio | 38 |
| Liquidity Ratios | 38 |

**Action**: Add rows for these KPIs to `daily_trade_series_mv`. The 96-point KPIs are sampled every 15 minutes (06:00–01:45 UTC). The 38-point KPIs are sampled at a lower cadence.

### 5C. Missing extremes (13 KPIs absent from `daily_trade_extremes_mv`)

The MV produces extremes for 5 KPIs. The reference has 18. Missing:

| Missing Extremes KPI | Ref hi/lo Count |
|---|---|
| Delta | 7 hi / 6 lo |
| Fair Market Price | 7 hi / 6 lo |
| Gamma | 7 hi / 6 lo |
| Rho | 7 hi / 6 lo |
| Theta | 7 hi / 6 lo |
| Uncertainty | 7 hi / 6 lo |
| Vega | 7 hi / 6 lo |
| Decay Rate | 4 hi / 3 lo |
| Gamma Exposure | 4 hi / 3 lo |
| IV Skew | 4 hi / 3 lo |
| Liquidity Ratios | 4 hi / 3 lo |
| OI Ratio | 4 hi / 3 lo |
| Volume Ratio | 4 hi / 3 lo |

The MV already produces: Daily PnL, Liquidity Drag, Mid Mark PnL, Percent Change, Unrealized P/L.

**Action**: Add `WHERE kpi_name IN (...)` expanded list to the extremes MV, or make it dynamic.

### 5D. Summary text

The summary field should include all non-dash KPIs in the format:
```
{signals_scanned} signals scanned • {opportunities_flagged} opportunities flagged • {entries_opened} entries opened • {exits_closed} exits closed • {daily_pnl} pnl.
```

Currently only: `47,324 signals scanned • -$1,457.99 pnl.`

### 5E. Reference trades.json

A complete reference file is checked into the downstream repo at:
```
docs/assets/trades/trades.json
```

The sync script should aim to produce a payload that matches this schema exactly. The downstream normalizer is flexible on field names but the **set of KPIs, series, and extremes must be complete**.

## 6. Data Volume Expectations

Per snapshot (typical trading day):

| Table | Row Count | Notes |
|---|---|---|
| KPIs | 26 | All 26 must have real values (no "—" dashes) |
| Series points | 1,800-6,000 | 26 KPIs × 38-96 points each |
| Extremes | 100-400 | 18 KPIs × 3-7 hi + 3-6 lo each |
| Portfolio assets | 24-200 | Active positions |
| **Total** | **~100-8,000** | Fits comfortably in D1 batch limits |

The API processes in chunks of 200 D1 statements per batch.

## 7. Build & Push

```bash
cd haiphen-gcp/jobs/haiphen-trades-sync
npm install
npm run build
docker build -t gcr.io/united-lane-361102/haiphen-trades-sync:latest .
docker push gcr.io/united-lane-361102/haiphen-trades-sync:latest
```

## 8. Secrets Setup

The sync job requires these environment variables (set as K8s Secrets or ConfigMap on the GKE cluster):

- `INTERNAL_TOKEN`: Must match the `INTERNAL_TOKEN` secret in haiphen-api (Cloudflare Worker)
- `SIGNING_SECRET`: HMAC-SHA256 key — must match `SIGNING_SECRET` in haiphen-api
- `DATABASE_URL`: PostgreSQL connection string (e.g., `postgresql://user:pass@host:5432/dbname`)
- `CLOUDFLARE_API_TOKEN`: Optional, only needed for direct `wrangler d1 execute` fallback

## 9. Fallback: Direct D1 Access

If the API endpoint is unreachable, the container can write directly to D1:

```bash
npm install -g wrangler
export CLOUDFLARE_API_TOKEN="..."

wrangler d1 execute haiphen_api \
  --command "INSERT INTO metrics_daily(date, ...) VALUES (...)" \
  --account-id 307a5117867a624064b8ec44fb1bac76 \
  --database-id 9a26fb67-b6e5-4d5f-8e62-3ecfde5ee8c2
```

The preferred path is always the API endpoint (handles normalization, caching, derived table rebuild).

## 10. Schedule

| CronJob | UTC Schedule | ET Equivalent |
|---|---|---|
| `trades-sync-premarket` | `0 14 * * 1-5` | 9:00 AM ET |
| `trades-sync-midday` | `30 17 * * 1-5` | 12:30 PM ET |
| `trades-sync-postmarket` | `30 21 * * 1-5` | 4:30 PM ET |

Weekdays only. `concurrencyPolicy: Forbid` prevents overlapping runs.
